generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model campaigns {
  id             String         @id
  eventId        String
  name           String
  description    String?
  targetPersonas String?
  minIcpScore    Int?
  startDate      DateTime?
  endDate        DateTime?
  status         CampaignStatus @default(DRAFT)
  goals          String?
  createdBy      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  events         events         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  outreach       outreach[]
  sequences      sequences[]

  @@index([eventId])
  @@index([status])
}

model company_dossiers {
  id               String          @id
  accountId        String          @unique
  companyOverview  String?
  recentNews       String?
  industryContext  String?
  keyPainPoints    String?
  techStack        String?
  companySize      String?
  socialPresence   String?
  rawData          String?
  researchedAt     DateTime        @default(now())
  researchedBy     String?
  facilityCount    String?
  locations        String?
  operationalScale String?
  target_accounts  target_accounts @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

model contact_insights {
  id                String   @id
  personId          String   @unique
  roleContext       String?
  likelyPainPoints  String?
  suggestedApproach String?
  roiOpportunity    String?
  confidence        String?
  generatedAt       DateTime @default(now())
  generatedBy       String?
  people            people   @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
}

model events {
  id               String            @id
  name             String
  location         String?
  startDate        DateTime
  endDate          DateTime
  status           EventStatus       @default(PLANNING)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  campaigns        campaigns[]
  target_accounts  target_accounts[]
  users            users[]
  ab_tests         ab_tests[]
  training_content training_content[]
}

model Meeting {
  id           String        @id
  personId     String
  scheduledAt  DateTime
  duration     Int
  location     String?
  status       MeetingStatus @default(SCHEDULED)
  meetingType  String?
  outcome      String?
  nextSteps    String?
  followUpDate DateTime?
  dealStage    String?
  notes        String?
  createdBy    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime
  people       people        @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([scheduledAt])
  @@map("meetings")
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model message_templates {
  id          String          @id
  name        String
  description String?
  channel     OutreachChannel
  subject     String?
  template    String
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime
}

model outreach {
  id             String          @id
  personId       String
  channel        OutreachChannel
  status         OutreachStatus  @default(DRAFT)
  subject        String?
  message        String
  templateId     String?
  sentBy         String?
  sentAt         DateTime?
  respondedAt    DateTime?
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  bouncedAt      DateTime?
  campaignId     String?
  openedAt       DateTime?
  sequenceId     String?
  gmailMessageId String?
  gmailThreadId  String?
  lastChecked    DateTime?
  campaigns      campaigns?      @relation(fields: [campaignId], references: [id])
  people         people          @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([personId])
  @@index([status])
  @@index([gmailThreadId])
  @@index([lastChecked])
  @@index([status, lastChecked])
}

model people {
  id                  String               @id
  accountId           String
  name                String
  title               String?
  email               String?
  phone               String?
  linkedin            String?
  notes               String?
  isExecOps           Boolean              @default(false)
  isOps               Boolean              @default(false)
  isProc              Boolean              @default(false)
  isSales             Boolean              @default(false)
  isTech              Boolean              @default(false)
  isNonOps            Boolean              @default(false)
  assignedTo          String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  emailStatus         String?
  unsubscribed        Boolean              @default(false)
  gdprConsent         Boolean              @default(false)
  contact_insights    contact_insights?
  meetings            Meeting[]
  outreach            outreach[]
  target_accounts     target_accounts      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  assignedUser        users?               @relation("PersonAssignments", fields: [assignedTo], references: [id])
  sequenceEnrollments SequenceEnrollment[]
  linkedin_profiles linkedin_profiles?

  @@index([accountId])
  @@index([assignedTo])
}

model roi_calculations {
  id               String          @id
  accountId        String
  facilityCount    Int?
  operationalScale String?
  annualSavings    Float?
  paybackPeriod    Int?
  assumptions      String?
  calculatedAt     DateTime        @default(now())
  calculatedBy     String?
  target_accounts  target_accounts @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

model score_history {
  id              String          @id
  accountId       String
  oldScore        Int?
  newScore        Int?
  reason          String
  changedBy       String?
  notes           String?
  createdAt       DateTime        @default(now())
  target_accounts target_accounts @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

model sequences {
  id          String     @id
  campaignId  String?
  name        String
  description String?
  steps       String
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  campaigns   campaigns? @relation(fields: [campaignId], references: [id])

  @@index([campaignId])
}

model target_accounts {
  id                  String               @id
  eventId             String
  name                String
  website             String?
  industry            String?
  headquarters        String?
  icpScore            Int?
  notes               String?
  assignedTo          String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  company_dossiers    company_dossiers?
  people              people[]
  roi_calculations    roi_calculations[]
  score_history       score_history[]
  email_patterns      email_patterns[]
  events              events               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  assignedUser        users?               @relation("AccountAssignments", fields: [assignedTo], references: [id])
  sequenceEnrollments SequenceEnrollment[]

  @@index([eventId])
  @@index([assignedTo])
}

model users {
  id                 String            @id
  name               String?
  email              String            @unique
  emailVerified      DateTime?
  password           String?
  image              String?
  role               Role              @default(MEMBER)
  activeEventId      String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime
  // Google OAuth & Sync
  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?
  googleSyncEnabled  Boolean           @default(false)
  googleSyncPaused   Boolean           @default(false)
  googleSyncDryRun   Boolean           @default(true)
  googleRateLimit    Int               @default(10)
  googleSyncAuditLog Json              @default("[]")
  lastGoogleSync     DateTime?
  events             events?           @relation(fields: [activeEventId], references: [id])
  activities         activities[]
  saved_searches     saved_searches[]
  notifications      notifications[]
  accountAssignments target_accounts[] @relation("AccountAssignments")
  personAssignments  people[]          @relation("PersonAssignments")
  training_content   training_content[]
  training_shares    training_shares[]
}

model activities {
  id          String   @id @default(cuid())
  userId      String
  entityType  String
  entityId    String
  action      String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())
  users       users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model saved_searches {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  entityType  String
  filters     Json
  isGlobal    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType])
  @@index([isGlobal])
}

model notifications {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

model ab_tests {
  id              String    @id @default(cuid())
  name            String
  description     String?
  status          String    @default("RUNNING") // RUNNING, COMPLETED, STOPPED
  templateAId     String
  templateBId     String
  sampleSize      Int       @default(100)
  winnerThreshold Float     @default(0.05) // 95% confidence
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  winnerId        String?
  results         Json? // {variantA: {sent, opened, clicked, replied}, variantB: {...}}
  createdBy       String
  eventId         String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  events          events    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum EventStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum OutreachChannel {
  EMAIL
  LINKEDIN
  PHONE
}

enum OutreachStatus {
  DRAFT
  SENT
  RESPONDED
  BOUNCED
  NO_RESPONSE
  SCHEDULED
  OPENED
}

enum Role {
  ADMIN
  MEMBER
}

model google_sync_locks {
  id        String   @id
  userId    String
  lockType  String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId, lockType])
  @@index([expiresAt])
}

model training_content {
  id           String   @id
  eventId      String
  userId       String
  source       String
  type         String
  title        String
  description  String?
  url          String
  downloadUrl  String?
  thumbnailUrl String?
  metadata     Json     @default("{}")
  fileSize     BigInt?
  duration     Int?
  mimeType     String?
  sourceId     String?
  sourceLink   String?
  tags         String[] @default([])
  status       String   @default("pending")
  processedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  event        events   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  creator      users    @relation(fields: [userId], references: [id])
  modules      training_module_content[]

  @@index([eventId])
  @@index([userId])
  @@index([source])
  @@index([status])
}

model training_module_content {
  id         String   @id
  moduleId   String
  contentId  String
  order      Int      @default(0)
  required   Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  content    training_content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  @@unique([moduleId, contentId])
  @@index([moduleId])
}

model training_shares {
  id         String    @id
  contentIds String[]
  shareCode  String    @unique
  createdBy  String
  expiresAt  DateTime?
  viewCount  Int       @default(0)
  createdAt  DateTime  @default(now())
  
  creator    users     @relation(fields: [createdBy], references: [id])
  
  @@index([shareCode])
}

model email_patterns {
  id              String          @id @default(cuid())
  accountId       String
  companyDomain   String
  patternType     String
  confidence      Float
  sampleSize      Int
  examples        String[]
  verifiedCount   Int             @default(0)
  bouncedCount    Int             @default(0)
  lastDetectedAt  DateTime        @default(now())
  lastVerifiedAt  DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  target_accounts target_accounts @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@unique([accountId, patternType])
  @@index([accountId])
  @@index([companyDomain])
  @@index([confidence])
}

model linkedin_profiles {
  id          String   @id @default(cuid())
  personId    String   @unique
  profileUrl  String
  confidence  Float
  foundVia    String   @default("google_search")
  verifiedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  people      people   @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  @@index([personId])
  @@index([confidence])
}

model OutreachSequence {
  id              String               @id @default(cuid())
  name            String
  description     String?
  steps           Json
  status          String               @default("draft")
  createdBy       String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  totalEnrolled   Int                  @default(0)
  totalCompleted  Int                  @default(0)
  totalActive     Int                  @default(0)
  
  enrollments     SequenceEnrollment[]
  
  @@index([createdBy])
  @@index([status])
}

model SequenceEnrollment {
  id              String           @id @default(cuid())
  sequenceId      String
  personId        String?
  accountId       String?
  currentStep     Int              @default(0)
  status          String           @default("active")
  startedAt       DateTime         @default(now())
  completedAt     DateTime?
  pauseReason     String?
  
  sequence        OutreachSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  person          people?          @relation(fields: [personId], references: [id], onDelete: Cascade)
  account         target_accounts? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  emailActivities EmailActivity[]
  
  @@index([sequenceId])
  @@index([personId])
  @@index([accountId])
  @@index([status])
}

model EmailActivity {
  id              String             @id @default(cuid())
  enrollmentId    String
  stepNumber      Int
  sentAt          DateTime           @default(now())
  openedAt        DateTime?
  clickedAt       DateTime?
  repliedAt       DateTime?
  bouncedAt       DateTime?
  unsubscribedAt  DateTime?
  spamReportAt    DateTime?
  status          String             @default("sent")
  messageId       String?            @unique
  subject         String
  body            String             @db.Text
  errorMessage    String?            @db.Text
  
  enrollment      SequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@index([enrollmentId])
  @@index([messageId])
  @@index([status])
  @@index([sentAt])
}
